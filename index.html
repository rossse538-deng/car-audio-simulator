<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è½½ä½éŸ³å•å…ƒä»¿çœŸåˆ†æå¼•æ“ V4.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --safe: #27ae60; --warn: #f39c12; --danger: #c0392b; 
            --neutral: #2980b9; --info: #8e44ad; --card-bg: #1e272e;
            --panel-bg: #2c3e50; --text: #ecf0f1; --border: #485460; --text-sub: #d2dae2;
        }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: #0f1419; color: var(--text); padding: 20px; line-height: 1.5; font-size: 14px; }
        .capture-wrapper { background: #0f1419; padding: 10px; border-radius: 8px; width: 100%; max-width: 850px; margin: auto; }
        .card { background: var(--card-bg); padding: 30px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
        
        h2 { text-align:center; margin-top:0; color: var(--text); font-weight: 600; font-size: 1.5rem; letter-spacing: 1px; margin-bottom: 5px;}
        
        .algo-header { text-align: center; position: relative; margin-bottom: 30px; }
        .algo-title { font-size: 0.8rem; color: #f1c40f; display: inline-block; padding: 4px 12px; border: 1px solid #f1c40f; border-radius: 20px; cursor: help; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        .algo-title:hover { background: rgba(241, 196, 15, 0.1); }
        .algo-tooltip { visibility: hidden; opacity: 0; width: 380px; background: #0b0f13; color: #cbd5e1; text-align: left; border-radius: 6px; padding: 15px; position: absolute; z-index: 10; top: 120%; left: 50%; transform: translateX(-50%); border: 1px solid #34495e; box-shadow: 0 10px 30px rgba(0,0,0,0.8); transition: opacity 0.3s, visibility 0.3s; font-size: 0.8rem; line-height: 1.6; }
        .algo-header:hover .algo-tooltip { visibility: visible; opacity: 1; }
        .math-line { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 4px; font-family: 'Courier New', monospace; color: #3498db; margin: 8px 0; font-weight: bold; border-left: 3px solid #3498db; letter-spacing: 0.5px;}
        .algo-tooltip h5 { margin: 0 0 10px 0; color: #fff; font-size: 0.95rem; border-bottom: 1px solid #333; padding-bottom: 8px;}

        .section-title { color: var(--warn); font-size: 0.85rem; font-weight: 700; border-bottom: 1px solid var(--border); margin: 25px 0 15px 0; padding-bottom: 5px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group { position: relative; }
        label { display: block; font-size: 0.8rem; color: var(--text-sub); margin-bottom: 6px; font-weight: 500; }
        input, select { width: 100%; padding: 10px; background: var(--panel-bg); border: 1px solid var(--border); color: #fff; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem; }
        input:focus, select:focus { border-color: var(--warn); outline: none; background: #3d566e; }
        
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .radio-label { display: flex; align-items: center; font-size: 0.85rem; cursor: pointer; color: #fff; font-weight: bold;}
        .radio-label input { width: auto; margin-right: 8px; }

        .tutorial-box { background: rgba(41, 128, 185, 0.1); border-left: 4px solid var(--neutral); padding: 15px; border-radius: 4px; margin-bottom: 15px; font-size: 0.85rem; color: #cbd5e1; line-height: 1.6;}
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .btn-calc { background: var(--neutral); color: white; }
        .btn-calc:hover { background: #1f6391; }
        .btn-share { background: var(--safe); color: white; display: none; }
        
        .res { margin-top: 30px; display: none; border-top: 1px solid var(--border); padding-top: 20px; }
        .section { background: var(--panel-bg); padding: 20px; border-radius: 6px; margin-bottom: 18px; border-left: 5px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        .status-safe { border-left-color: var(--safe); }
        .status-warn { border-left-color: var(--warn); }
        .status-danger { border-left-color: var(--danger); }
        
        h4 { margin: 0 0 15px 0; color: #fff; border-bottom: 1px solid var(--border); padding-bottom: 8px; font-size: 1.05rem; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 0.7rem; padding: 3px 8px; background: rgba(0,0,0,0.3); color: var(--text-sub); border: 1px solid var(--border); border-radius: 3px; font-weight: normal;}
        
        .data-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
        .main-val { font-size: 1.8rem; font-weight: 700; line-height: 1; }
        .sub-data { text-align: right; font-size: 0.85rem; color: var(--text-sub); line-height: 1.5; }
        
        .intent-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .intent-item { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 4px; border: 1px dashed #555; }
        .intent-title { color: #f1c40f; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; text-transform: uppercase;}
        .intent-desc { font-size: 0.85rem; color: #ddd; line-height: 1.4;}

        .dual-advice { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .da-card { background: rgba(0,0,0,0.25); padding: 15px; border-radius: 6px; border: 1px solid var(--border); border-top: 3px solid var(--neutral);}
        .da-title { font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
        .da-val { font-size: 1.3rem; font-weight: bold; color: #fff; }
        .da-desc { font-size: 0.85rem; color: #a4b0be; margin-top: 10px; line-height: 1.6; }
        
        .final-verdict { background: rgba(0,0,0,0.3); border: 1px solid #555; padding: 18px; border-radius: 6px; margin-top: 15px; }
        .verdict-item { margin-bottom: 12px; display: flex; align-items: flex-start; font-size: 0.9rem; line-height: 1.5; }
        .verdict-item:last-child { margin-bottom: 0; }
        .verdict-icon { margin-right: 10px; font-size: 1.2rem; flex-shrink: 0; }
        
        .watermark { text-align: center; color: #555; font-size: 0.75rem; margin-top: 25px; border-top: 1px solid #333; padding-top: 15px; display: none; font-weight: bold;}
    </style>
</head>
<body>

<div id="capture-target" class="capture-wrapper">
    <div class="card">
        <h2>è½¦è½½ä½éŸ³å•å…ƒä»¿çœŸåˆ†æå¼•æ“</h2>
        <div class="algo-header">
            <span class="algo-title">ç‰©ç†æ¨æ¼”æ¨¡å‹: å®¢è§‚ T/S åˆ†æ & éå¯¹ç§°å£°å­¦å¯¹é½</span>
            <div class="algo-tooltip">
                <h5>ğŸ“ æ ¸å¿ƒç‰©ç†ä¸æ•°å­¦è®¡ç®—æ¨¡å‹</h5>
                åŸºäºå®¢è§‚ç”µå£°å­¦å®šå¾‹è¿›è¡Œé—­ç¯æ¨æ¼”ï¼š<br><br>
                <b>1. éœå¤«æ›¼é“å¾‹ (Hofmann's Iron Law)</b><br>
                æ‰¬å£°å™¨çš„çµæ•åº¦(Î·â‚€)ã€è°æŒ¯é¢‘ç‡(Fs)ä¸ç­‰æ•ˆå®¹ç§¯(Vas)å­˜åœ¨ç»å¯¹çš„ç‰©ç†åˆ¶çº¦ï¼Œå¼•æ“æ®æ­¤æ ¡éªŒå‚æ•°çœŸä¼ªï¼š
                <div class="math-line">Î·â‚€ = k Ã— V_as Ã— F_sÂ³</div>
                <b>2. åŠ¨æ€è£…è½¦é˜»å°¼ä¼°ç®— (Lossy Baffle)</b><br>
                å°†è½¦é—¨è§†ä¸ºå¸¦æ³„éœ²å› å­çš„æœ‰é™å¤§éšœæ¿ï¼Œå¼•å…¥æ°”å¯†ç³»æ•°(L)æ¨æ¼”è£…è½¦åçš„çœŸå®é˜»å°¼(Qtc)ï¼š
                <div class="math-line">Q_tc = Q_ts Ã— âˆš(1 + L Ã— (V_as / V_b))</div>
                <b>3. éå¯¹ç§°ç”µå£°å åŠ ç†è®º (Acoustic LR4)</b><br>
                æœ€ç»ˆå£°å­¦æ»šé™ = æ‰¬å£°å™¨è‡ªç„¶ç‰©ç†è¡°å‡ + DSP ç”µå­¦ç½‘ç»œã€‚
                <div class="math-line">Acoustic 24dB â‰ˆ Natural 12dB + DSP HPF 12dB</div>
            </div>
        </div>
        
        <!-- æ¨¡å— 1ï¼šç³»ç»Ÿè¾¹ç•Œä¸é…ç½® -->
        <div class="section-title">1. å£°å­¦è¾¹ç•Œæ¡ä»¶ & éŸ³å“ç³»ç»Ÿé…ç½®</div>
        <div class="input-grid">
            <div class="input-group">
                <label>è½¦å‹é—¨æ¿å£°å­¦å®¹ç§¯ (Vb)</label>
                <select id="car_type">
                    <option value="30">æ—¥éŸ©ç³»/A0çº§å°è½¦ (çº¦ 30L)</option>
                    <option value="45" selected>ç´§å‡‘/ä¸­çº§è½¿è½¦ (çº¦ 45L)</option>
                    <option value="60">ä¸­å¤§å‹SUV (çº¦ 60L)</option>
                    <option value="40">è±ªåè½¦/é«˜åˆšæ€§é—¨æ¿ (çº¦ 40L)</option>
                </select>
            </div>
            <div class="input-group">
                <label>é—¨æ¿éš”éŸ³å¤„ç†çŠ¶æ€</label>
                <select id="door_treat">
                    <option value="0.4">åŸè½¦æ— éš”éŸ³ (æ˜¾è‘—æ¼æ°”)</option>
                    <option value="0.75" selected>æ ‡å‡†åŒå±‚æ­¢éœ‡æ¿ (æœ‰é™éšœæ¿)</option>
                    <option value="0.95">ä¸‰å±‚å¯†å°å¤„ç† (è¿‘ä¼¼éç†æƒ³å¯†é—­)</option>
                    <option value="1.0">é—¨æ¿å€’æ¨¡ç‹¬ç«‹å¯†é—­ç®±</option>
                </select>
            </div>
            <div class="input-group">
                <label>æ˜¯å¦é…å¤‡è¶…ä½éŸ³å•å…ƒ (Subwoofer)ï¼Ÿ</label>
                <select id="has_sub">
                    <option value="yes" selected>æœ‰ç‹¬ç«‹è¶…ä½éŸ³ç³»ç»Ÿ</option>
                    <option value="no">æ—  (ä¾èµ–å‰é—¨è¾“å‡ºæä½é¢‘)</option>
                </select>
            </div>
        </div>

        <!-- æ¨¡å— 2ï¼šå‚æ•°è¾“å…¥ -->
        <div class="section-title">2. æ‰¬å£°å™¨å‚æ•°è¾“å…¥</div>
        <div class="radio-group">
            <label class="radio-label">
                <input type="radio" name="param_mode" value="ts_known" checked onchange="toggleParamMode()"> å·²çŸ¥å‡†ç¡® T/S å‚æ•°
            </label>
            <label class="radio-label">
                <input type="radio" name="param_mode" value="ts_unknown" onchange="toggleParamMode()"> æ—  T/S å‚æ•° (åˆ†ææ¨æ¼”)
            </label>
        </div>

        <!-- çŠ¶æ€ Aï¼šå·²çŸ¥ T/S -->
        <div id="panel_known" style="display: block;">
            <div class="input-grid">
                <div><label>Fs è°æŒ¯é¢‘ç‡ (Hz)</label><input type="number" id="ts_fs" value="49"></div>
                <div><label>Qts æ€»å“è´¨å› æ•°</label><input type="number" id="ts_qts" value="0.9" step="0.01"></div>
                <div><label>Vas ç­‰æ•ˆå®¹ç§¯ (L)</label><input type="number" id="ts_vas" value="30"></div>
            </div>
        </div>

        <!-- çŠ¶æ€ B/Cï¼šæœªçŸ¥ T/S -->
        <div id="panel_unknown" style="display: none;">
            <div class="radio-group" style="background: transparent; padding: 0; border: none;">
                <label class="radio-label">
                    <input type="radio" name="unknown_submode" value="autotest" checked onchange="toggleSubMode()"> å®æµ‹æ•°æ® (é¦–é€‰)
                </label>
                <label class="radio-label">
                    <input type="radio" name="unknown_submode" value="deduce" onchange="toggleSubMode()"> æ ‡ç§°å‚æ•°ç»“åˆæ¨æ¼”
                </label>
            </div>

            <!-- çŠ¶æ€ Bï¼šå®æµ‹æ•°æ® -->
            <div id="panel_autotest" style="display: block;">
                <div class="tutorial-box">
                    ğŸ› ï¸ <b>ä¸‡ç”¨è¡¨ Fs ç®€æ˜“æµ‹å®šæ³•ï¼š</b><br>
                    å°†ä¸‡ç”¨è¡¨è°ƒè‡³äº¤æµç”µå‹æ¡£(ACV)å¹¶è”å–‡å­æ­£è´Ÿæã€‚æ‰‹æœºè¿æ¥åŠŸæ”¾æ’­æ”¾ 20Hz-100Hz æ…¢é€Ÿæ‰«é¢‘ã€‚è§‚å¯Ÿä¸‡ç”¨è¡¨ï¼Œ<b>äº¤æµç”µå‹è¯»æ•°å†²åˆ°æœ€é«˜å³°å€¼é‚£ä¸€ç¬é—´æ‰€å¯¹åº”çš„é¢‘ç‡ï¼Œå³ä¸ºè¯¥å–‡å­çœŸå®çš„ Fs</b>ã€‚
                </div>
                <div class="input-grid">
                    <div><label>å®æµ‹å‡ºå³°å€¼ç”µå‹æ—¶çš„é¢‘ç‡ Fs (Hz)</label><input type="number" id="test_fs" placeholder="å¦‚: 65"></div>
                    <div><label>æ‰‹æŒ‡æŒ‰å‹çº¸ç›†çš„ç‰©ç†é˜»åŠ›</label>
                        <select id="test_suspension">
                            <option value="stiff">åç¡¬ (å›å¼¹è¿…é€Ÿï¼Œé«˜çµæ•å–å‘)</option>
                            <option value="mid" selected>é€‚ä¸­</option>
                            <option value="soft">åè½¯ (å®¹æ˜“æŒ‰å‹ï¼Œæ·±æ½œå–å‘)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- çŠ¶æ€ Cï¼šå‚æ•°ç»“åˆæ¨æ¼” -->
            <div id="panel_deduce" style="display: none;">
                <div class="tutorial-box">
                    åˆ©ç”¨ã€Šéœå¤«æ›¼é“å¾‹ã€‹(Hofmann's Iron Law)ï¼Œé€šè¿‡æ‰¬å£°å™¨æ ‡ç§°çš„çµæ•åº¦ä¸ä¸‹æ½œé¢‘ç‡è¿›è¡Œäº¤å‰æ¯”å¯¹ï¼Œå¯ç§‘å­¦é”å®šæ‰¬å£°å™¨çš„çœŸå®ç‰©ç†æ¶æ„ã€‚
                </div>
                <div class="input-grid">
                    <div><label>æ ‡ç§°é¢‘å“ä¸‹é™ (Hz)</label><input type="number" id="deduce_freq" placeholder="å¦‚: 45"></div>
                    <div><label>æ ‡ç§°çµæ•åº¦ (dB/1W/1m)</label><input type="number" id="deduce_sens" placeholder="å¦‚: 89"></div>
                    <div><label>æ‰‹æŒ‡æŒ‰å‹çº¸ç›†çš„ç‰©ç†é˜»åŠ›</label>
                        <select id="deduce_suspension">
                            <option value="stiff">åç¡¬</option>
                            <option value="mid" selected>é€‚ä¸­</option>
                            <option value="soft">åè½¯</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-calc" onclick="calculate()">æ‰§è¡Œå£°å­¦ä»¿çœŸä¸ DSP è®¡ç®—</button>
            <button class="btn-share" id="shareBtn" onclick="takeScreenshot()">ğŸ“¸ å¯¼å‡ºåˆ†ææŠ¥å‘Š</button>
        </div>

        <div id="res" class="res">
            <!-- æ¨¡å— 1ï¼šQtcå£°å­¦å“åº” -->
            <div id="qtc_eval" class="section"></div>

            <!-- æ¨¡å— 2ï¼šæ‰¬å£°å™¨è®¾è®¡å–å‘å‰–æ -->
            <div id="intent_eval" class="section" style="border-left-color: #f1c40f;"></div>
            
            <!-- æ¨¡å— 3ï¼šéå¯¹ç§° DSP ç­–ç•¥ -->
            <div id="dsp_eval" class="section status-safe"></div>

            <!-- æ¨¡å— 4ï¼šç³»ç»Ÿç»¼åˆè¯Šæ–­ -->
            <div id="multi_eval" class="section" style="border-left-color: var(--neutral); border-left-width: 6px;">
                <h4>ç³»ç»Ÿç»¼åˆè¯Šæ–­ <span class="tag">System Diagnostics</span></h4>
                <div class="final-verdict" id="final_verdict_content"></div>
            </div>
            
            <div class="watermark" id="watermark">
                è½¦è½½å£°å­¦å®¢è§‚ä»¿çœŸå¼•æ“ | å¯¼å‡ºäº <span id="date-time"></span>
            </div>
        </div>
    </div>
</div>

<script>
function toggleParamMode() {
    const isKnown = document.querySelector('input[name="param_mode"]:checked').value === 'ts_known';
    document.getElementById('panel_known').style.display = isKnown ? 'block' : 'none';
    document.getElementById('panel_unknown').style.display = isKnown ? 'none' : 'block';
}

function toggleSubMode() {
    const isAutotest = document.querySelector('input[name="unknown_submode"]:checked').value === 'autotest';
    document.getElementById('panel_autotest').style.display = isAutotest ? 'block' : 'none';
    document.getElementById('panel_deduce').style.display = isAutotest ? 'none' : 'block';
}

function calculate() {
    const v_base = parseFloat(document.getElementById('car_type').value); 
    const leak_factor = parseFloat(document.getElementById('door_treat').value);
    const has_sub = document.getElementById('has_sub').value;

    let fs, qts, vas = 15, xmax = 4.0;
    let advice_items =[]; 
    let bs_flag = false;   

    const mode = document.querySelector('input[name="param_mode"]:checked').value;
    
    // å‚æ•°è·å–é€»è¾‘
    if (mode === 'ts_known') {
        fs = parseFloat(document.getElementById('ts_fs').value);
        qts = parseFloat(document.getElementById('ts_qts').value);
        vas = parseFloat(document.getElementById('ts_vas').value) || 15;
        if (isNaN(fs) || isNaN(qts)) { alert("è¯·è¾“å…¥å®Œæ•´çš„ Fs å’Œ Qts"); return; }
        xmax = (fs < 55) ? 6.0 : (fs > 85 ? 2.0 : 4.0);
    } else {
        const submode = document.querySelector('input[name="unknown_submode"]:checked').value;
        if (submode === 'autotest') {
            fs = parseFloat(document.getElementById('test_fs').value);
            if (isNaN(fs)) { alert("è¯·è¾“å…¥å®æµ‹çš„ Fs"); return; }
            const susp = document.getElementById('test_suspension').value;
            qts = (susp === 'stiff') ? 0.8 : (susp === 'soft' ? 0.45 : 0.65);
            xmax = (susp === 'soft') ? 6.0 : 4.0;
        } else {
            const f_nom = parseFloat(document.getElementById('deduce_freq').value) || 60;
            const sens = parseFloat(document.getElementById('deduce_sens').value) || 89;
            const susp = document.getElementById('deduce_suspension').value;

            // éœå¤«æ›¼é“å¾‹æ’æŸ¥ï¼šé«˜çµæ•åº¦ + æä½æ½œ + ç¡¬æ‚¬æŒ‚ = ç‰©ç†æ‚–è®º
            if (sens >= 91 && f_nom < 45 && susp === 'stiff') {
                bs_flag = true;
                fs = 65; qts = 0.85; 
                advice_items.push(`<span style="color:#e74c3c">âš ï¸ <b>éœå¤«æ›¼é“å¾‹æ ¡éªŒæœªé€šè¿‡ï¼š</b> æ ‡ç§°é«˜çµæ•åº¦ (${sens}dB) ä¸æä½æ½œ (${f_nom}Hz) åœ¨æ‚¬æŒ‚åç¡¬çš„ç‰©ç†é™åˆ¶ä¸‹ä¸å¯å…¼å¾—ã€‚å·²è‡ªåŠ¨å‰”é™¤ç†æƒ³åŒ–ä¸‹æ½œå‚æ•°ï¼ŒæŒ‰å¸¸è§„é«˜æ•ˆç‡è½¦é—¨ä¸­ä½éŸ³ (ä¼°ç®— Fs=${fs}Hz) è¿›è¡Œå®¢è§‚æ¨æ¼”ã€‚</span>`);
            } else {
                fs = Math.max(f_nom + 5, 40); // é¢„ç•™å‚å®¶æµ‹è¯•ç¯å¢ƒåå·®å®¹å·®
                if (sens >= 90) {
                    qts = (susp === 'stiff') ? 0.85 : (susp === 'soft' ? 0.65 : 0.75);
                    xmax = (susp === 'soft') ? 5.0 : 3.5;
                } else if (sens <= 87) {
                    qts = (susp === 'stiff') ? 0.6 : (susp === 'soft' ? 0.45 : 0.55);
                    xmax = (susp === 'soft') ? 8.0 : 6.0;
                } else {
                    qts = (susp === 'stiff') ? 0.75 : (susp === 'soft' ? 0.55 : 0.65);
                    xmax = 4.5;
                }
            }
        }
    }

    // --- ç‰©ç†è£…è½¦å£°å­¦æ¨æ¼” (Lossy Baffle æ¨¡å‹) ---
    const alpha = vas / v_base;
    let qtc, fc;
    if (leak_factor >= 0.95) { 
        qtc = qts * Math.sqrt(1 + alpha);
    } else { 
        qtc = qts * Math.sqrt(1 + alpha * leak_factor); 
    }
    fc = fs * (qtc / qts);
    
    let peak_db = 0;
    if (qtc > 0.707) {
        let q_sq = qtc * qtc;
        peak_db = 20 * Math.log10(q_sq / Math.sqrt(q_sq - 0.5));
    }

    let f_cancel = (leak_factor === 0.4) ? 80 : (leak_factor === 0.75 ? 40 : 0);

    // --- æ˜¾ç¤ºæ§åˆ¶ ---
    document.getElementById('res').style.display = 'block';
    document.getElementById('shareBtn').style.display = 'block';
    document.getElementById('watermark').style.display = 'block';
    document.getElementById('date-time').innerText = new Date().toLocaleString();

    // --- æ¨¡å— 2ï¼šè®¾è®¡æ¶æ„æ„å›¾è¯†åˆ« ---
    let intent_mech = "", intent_app = "";
    let is_free_air = false;

    if (fs <= 55 && qts >= 0.8) {
        is_free_air = true;
        intent_mech = "è¾ƒä½è°æŒ¯é¢‘ç‡ (Fs) é…åˆ è¾ƒé«˜æ€»å“è´¨å› æ•° (Qts)ã€‚";
        intent_app = "å…¸å‹çš„ <b>Free-Air (æ— é™å¤§éšœæ¿) å–å‘è®¾è®¡</b>ã€‚è®¾è®¡å¸ˆç‰¹æ„åˆ©ç”¨è¾ƒé«˜çš„ Qts æ¥ç»´æŒå–‡å­åœ¨æ¼æ°”è½¦é—¨ç¯å¢ƒä¸­çš„ä½é¢‘ä¸‹æ½œèƒ½åŠ›ï¼Œä¸ä¾èµ–å¯†é—­ç®±ä½“çš„ç©ºæ°”å¼¹ç°§ã€‚é€‚åˆç›´æ¥åˆ©ç”¨åŸè½¦é—¨å®¹ç§¯å‘æŒ¥ä½œç”¨ã€‚";
    } else if (fs >= 65 && fs <= 85 && qts > 0.6) {
        intent_mech = "è¾ƒé«˜è°æŒ¯é¢‘ç‡ é…åˆ é€‚ä¸­æœºæ¢°é˜»å°¼ã€‚";
        intent_app = "<b>é«˜æ•ˆç‡ä¸­ä½éŸ³å–å‘</b>ã€‚åœ¨å·¥ç¨‹å­¦ä¸Šé€‚å½“ç‰ºç‰²æä½é¢‘ä¸‹æ½œï¼Œæ¢å– 80-150Hz é¢‘æ®µä¼˜ç§€çš„ç¬æ€å“åº”ä¸æ‰“å‡»åŠ›ï¼Œå»ºè®®å¿…é¡»æ­é…ç‹¬ç«‹è¶…ä½éŸ³å¼¥è¡¥ä¸‹ç›˜ã€‚";
    } else if (qts <= 0.55 && fs < 55) {
        intent_mech = "å¼ºç”µç£æ§åˆ¶åŠ› é…åˆ é«˜é¡ºæ€§(åè½¯)æŠ˜ç¯ã€‚";
        intent_app = "<b>å¯†é—­ç®±/å€’ç›¸ç®±å–å‘å•å…ƒ</b>ã€‚æåº¦ä¾èµ–ç®±ä½“ç©ºæ°”å¼¹ç°§æä¾›æ”¯æ’‘åŠ›ã€‚è‹¥å¼ºè¡Œå®‰è£…åœ¨æœªå®Œå…¨å¯†å°çš„è½¦é—¨ä¸­ï¼Œä½é¢‘é‡æ„Ÿå¯èƒ½åå°‘ï¼Œä¸”åœ¨å¤§åŠ¨æ€ä¸‹å®¹æ˜“å‡ºç°å†²ç¨‹è¿‡è½½ã€‚";
    } else if (fs > 85) {
        intent_mech = "è½»é‡åŒ–æŒ¯è†œ é…åˆ çŸ­å†²ç¨‹ç»“æ„ã€‚";
        intent_app = "<b>çº¯ä¸­éŸ³æˆ–é˜µåˆ—å•å…ƒ</b>ã€‚ä¸»è¦è´Ÿè´£ä¸­é¢‘äººå£°è¡¨ç°ï¼Œä½é¢‘èƒ½åŠ›æå¼±ï¼Œéœ€è®¾å®šè¾ƒé«˜çš„é«˜é€šåˆ†é¢‘ç‚¹ã€‚";
    } else {
        intent_mech = "å¸¸è§„å†²ç¨‹ä¸é€‚ä¸­çš„é˜»å°¼å‚æ•°ç‰¹æ€§ã€‚";
        intent_app = "<b>é€šç”¨å‹è½¦é—¨ä¸­ä½éŸ³å•å…ƒ</b>ã€‚å…¼é¡¾äººå£°è¡¨ç°ä¸åŸºç¡€ä½é¢‘æ°›å›´ï¼Œå¯¹å¸¸è§„å®‰è£…ç¯å¢ƒçš„é€‚åº”æ€§å¹¿ï¼Œå®¹å·®ç‡è¾ƒé«˜ã€‚";
    }

    // --- æ¨¡å— 1ï¼šç³»ç»Ÿå£°å­¦é˜»å°¼åˆ¤å®š ---
    let q_class = "", q_title = "";
    if (is_free_air) {
        q_class = "status-safe"; 
        q_title = "ç¬¦åˆæ— é™å¤§éšœæ¿ (IB) è®¾è®¡é¢„æœŸï¼Œåˆ©ç”¨è‡ªèº«é˜»å°¼ç»´æŒä½é¢‘é‡æ„Ÿã€‚";
    } else {
        if (qtc < 0.6) { q_class = "status-warn"; q_title = "è½»åº¦è¿‡é˜»å°¼ (ç¬æ€å“åº”å¹²å‡€ï¼Œä½†ä½é¢‘é‡æ„Ÿå¯èƒ½åè–„)"; } 
        else if (qtc >= 0.6 && qtc <= 0.85) { q_class = "status-safe"; q_title = "é˜»å°¼é€‚ä¸­ (ç³»ç»Ÿç¬æ€ä¸ä½é¢‘é‡æ„Ÿå–å¾—è¾ƒä½³å¹³è¡¡)"; } 
        else if (qtc <= 1.1) { q_class = "status-warn"; q_title = "è½»åº¦æ¬ é˜»å°¼ (ä½é¢‘é‡æ„Ÿä¸°æ»¡ï¼Œè¿åˆæµè¡Œå¬éŸ³å–œå¥½)"; } 
        else { q_class = "status-danger"; q_title = "æ˜¾è‘—æ¬ é˜»å°¼ (ä½é¢‘èƒ½é‡ç´¯ç§¯è¾ƒå¼ºï¼Œéœ€æ³¨æ„ä¸­ä½é¢‘æµ‘æµŠé—®é¢˜)"; }
    }

    document.getElementById('qtc_eval').className = "section " + q_class;
    document.getElementById('qtc_eval').innerHTML = `
        <h4>è£…è½¦å£°å­¦é˜»å°¼ä¼°ç®— (System Qtc) <span class="tag">Physics Output</span></h4>
        <div class="data-row">
            <div class="main-val" style="color:${q_class === 'status-safe' ? '#27ae60' : (q_class === 'status-warn' ? '#f39c12' : '#c0392b')}">Qtc â‰ˆ ${qtc.toFixed(2)}</div>
            <div class="sub-data">
                ä¼°ç®—è£…è½¦è°æŒ¯ (Fc): <b>${Math.round(fc)} Hz</b>
            </div>
        </div>
        ${peak_db > 0 ? `<div style="font-size:0.85rem; margin-top:5px; text-align:right; color:#a4b0be;">æ¨æ¼”å…±æŒ¯å¢ç›Šï¼šç³»ç»Ÿå°†åœ¨ ${Math.round(fc)}Hz é™„è¿‘äº§ç”Ÿçº¦ <b>+${peak_db.toFixed(1)} dB</b> çš„è‡ªç„¶ç‰©ç†å¢ç›Šã€‚</div>` : ''}
        <div class="da-desc" style="color:#ecf0f1; font-weight:bold; margin-top:8px;">å·¥ç¨‹åˆ¤å®šï¼š${q_title}</div>
    `;

    document.getElementById('intent_eval').innerHTML = `
        <h4>æ‰¬å£°å™¨è®¾è®¡å–å‘å‰–æ <span class="tag">Architecture Intent</span></h4>
        <div class="intent-grid">
            <div class="intent-item">
                <div class="intent-title">âš™ï¸ å‚æ•°ç‰¹å¾æ¨æ¼”</div>
                <div class="intent-desc">${intent_mech} (åŸºç¡€æ¨æµ‹: Fsâ‰ˆ${Math.round(fs)}Hz / Qtsâ‰ˆ${qts.toFixed(2)})</div>
            </div>
            <div class="intent-item">
                <div class="intent-title">ğŸ¯ æœ€ä½³å·¥ç¨‹åº”ç”¨åœºæ™¯</div>
                <div class="intent-desc">${intent_app}</div>
            </div>
        </div>
    `;

    // --- æ¨¡å— 3ï¼šéå¯¹ç§° DSP ç­–ç•¥ (åŸºäºç”¨æˆ·å·¥ç¨‹å®è·µ) ---
    let hpf_freq = 50, hpf_slope = "12dB/Oct Butterworth";
    let lpf_freq = 60, lpf_slope = "24dB/Oct Butterworth";
    let dsp_rationale = "";

    if (fc <= 75 && xmax >= 3.5) {
        dsp_rationale = `ğŸ’¡ <b>éå¯¹ç§°å£°å­¦å¯¹é½ç­–ç•¥ (åŸºç¡€æ¨èåŸºå‡†)ï¼š</b><br>
        1. <b>å£°å­¦æ–œç‡èåˆï¼š</b> è½¦é—¨ä¸­ä½éŸ³åœ¨ç‰©ç†ç¯å¢ƒä¸­å­˜åœ¨è‡ªç„¶çš„ä½é¢‘æ»šé™ (é€šå¸¸çº¦ä¸º 12dB/Oct)ã€‚å åŠ  <b>12dB/Oct ç”µå­¦é«˜é€š (50Hz)</b> åï¼Œå¯è¿‘ä¼¼å½¢æˆ <b>24dB/Oct çš„æ€»å£°å­¦æ»šé™</b>ã€‚<br>
        2. <b>ç›¸ä½åŒå‘å¯¹æ¥ï¼š</b> æ­¤ç­–ç•¥ä½¿å‰é—¨ä¸è¶…ä½éŸ³ (è®¾ç½® <b>24dB/Oct ç”µå­¦ä½é€š 60Hz</b>) åœ¨äº¤æ¥åŒºå®ç°è¿‘ä¼¼ Linkwitz-Riley (LR4) çš„å¯¹ç§°åŒ¹é…ï¼Œç†è®ºä¸Šèƒ½è¾¾æˆä¼˜ç§€çš„ç›¸ä½åŒå‘è¡”æ¥ã€‚<br>
        3. <b>é¢‘ç‡é‡å  (Overlap)ï¼š</b> 50Hz(HP) ä¸ 60Hz(LP) çš„ç”µå­¦é‡å è®¾ç½®ï¼Œæœ‰åŠ©äºå¼¥è¡¥è½¦å¢å£°å­¦ç¯å¢ƒå¯¼è‡´çš„äº¤æ¥ç‚¹èƒ½é‡é™·é˜±ã€‚`;
    } else {
        hpf_freq = Math.max(60, Math.round(fc * 1.1));
        hpf_slope = "12dB/Oct æˆ– 24dB/Oct";
        lpf_freq = Math.min(80, hpf_freq + 10);
        dsp_rationale = `ğŸ“Œ <b>é˜²è¡°å‡ä¸å†²ç¨‹ä¿æŠ¤ç­–ç•¥ï¼š</b><br>
        å› è¯¥å•å…ƒè£…è½¦è°æŒ¯åé«˜æˆ–å†²ç¨‹ç‰©ç†é™åˆ¶ï¼Œä¸ºé˜²æ­¢æ‰¬å£°å™¨è¿‡è½½å¤±çœŸï¼Œé«˜é€šå»ºè®®è®¾å®šåœ¨ <b>${hpf_freq}Hz</b> é™„è¿‘ã€‚<br>
        åŒæ—¶å°†è¶…ä½éŸ³çš„ä½é€šç›¸åº”ä¸Šç§»è‡³ <b>${lpf_freq}Hz</b> ä»¥é˜²ä¸­ä½é¢‘æ®µèƒ½é‡æ–­å±‚ã€‚æ³¨æ„ï¼šä½é€šé¢‘ç‡è¿‡é«˜å¯èƒ½ä¼šå¼•å‘å£°åƒåç§»ï¼Œè¯·ä¾æ®å®é™…å¬æ„Ÿå¾®è°ƒä½éŸ³ç‚®ç”µå¹³ã€‚`;
    }

    document.getElementById('dsp_eval').innerHTML = `
        <h4>DSP å£°å­¦ä¸ç”µå­¦å¯¹é½å‚è€ƒ <span class="tag">Acoustic Alignment</span></h4>
        <div class="dual-advice">
            <div class="da-card" style="border-top-color:#3498db;">
                <div class="da-title">ä¸­ä½éŸ³ HPF (ä½é¢‘åˆ‡é™¤)</div>
                <div class="da-val" style="color:#3498db">${hpf_freq} Hz</div>
                <div style="font-size:0.8rem;color:#888;">${hpf_slope}</div>
            </div>
            <div class="da-card" style="border-top-color:${has_sub === 'yes' ? '#e67e22' : '#7f8c8d'};">
                <div class="da-title">è¶…ä½éŸ³ LPF (é«˜é¢‘åˆ‡é™¤)</div>
                <div class="da-val" style="color:${has_sub === 'yes' ? '#e67e22' : '#7f8c8d'}">${has_sub === 'yes' ? lpf_freq + ' Hz' : 'æ— ç‹¬ç«‹è¶…ä½éŸ³'}</div>
                <div style="font-size:0.8rem;color:#888;">${has_sub === 'yes' ? lpf_slope : 'N/A'}</div>
            </div>
        </div>
        <div class="da-desc" style="margin-top:12px;">${dsp_rationale}</div>
    `;

    // --- æ¨¡å— 4ï¼šç³»ç»Ÿç»¼åˆè¯Šæ–­ ---
    if (is_free_air && qtc > 1.0) {
        advice_items.push(`âœ… <b>è®¾è®¡ç‰¹æ€§åŒ¹é…ï¼š</b> è¯¥å•å…ƒåˆ©ç”¨é«˜ Qts åœ¨å¼€æ”¾ç©ºé—´è·å–ä½é¢‘ï¼Œä¼°ç®—çš„è¾ƒé«˜ Qtc å±æ­£å¸¸å·¥ç¨‹é¢„æœŸã€‚${peak_db > 0 ? `è‹¥å®é™…å¬æ„Ÿè®¤ä¸º ${Math.round(fc)}Hz é™„è¿‘ç•¥æ˜¾åšé‡ï¼Œå¯é€šè¿‡ DSP å‡è¡¡å™¨ä½œ -2 è‡³ -3dB çš„è½»å¾®å‹é™ã€‚` : ''}`);
    } else if (!is_free_air) {
        if (qtc < 0.6) {
            advice_items.push(`â„¹ï¸ <b>é˜»å°¼åé«˜æç¤ºï¼š</b> ç³»ç»Ÿå‘ˆè½»åº¦è¿‡é˜»å°¼çŠ¶æ€ï¼Œä½é¢‘ç¬æ€æ¸…æ™°ä½†ä¸‹æ½œå¬æ„Ÿå¯èƒ½åè–„ã€‚è‹¥éœ€å¢åŠ æ°›å›´æ„Ÿï¼Œå¯é€‚å½“å¢åŠ è¶…ä½éŸ³å¢ç›Šæˆ–è¾…ä»¥é€‚åº¦çš„ EQ è¡¥å¿ã€‚`);
        } else if (qtc > 1.2) {
            advice_items.push(`âš ï¸ <b>æ¬ é˜»å°¼ç•™æ„ï¼š</b> Qtc é«˜è¾¾ ${qtc.toFixed(2)}ï¼Œå¯èƒ½äº§ç”Ÿè¾ƒæ˜æ˜¾çš„ä½é¢‘é©»æ³¢æˆ–æ‹–å°¾æ„Ÿã€‚å»ºè®®åˆ©ç”¨ DSP å‚æ•°å‡è¡¡å™¨ (PEQ) åœ¨ ${Math.round(fc)}Hz é™„è¿‘è¿›è¡Œé€‚åº¦è¡°å‡æ§åˆ¶ã€‚`);
        }
    }

    if (f_cancel >= hpf_freq) {
        advice_items.push(`âš ï¸ <b>è½¦é—¨éš”éŸ³å»ºè®®ï¼š</b> å½“å‰éš”éŸ³çŠ¶æ€å¯èƒ½åœ¨ ${f_cancel}Hz é™„è¿‘å¼•å‘æ˜æ˜¾çš„å‰åå£°æ³¢çŸ­è·¯æŠµæ¶ˆã€‚å»ºè®®åæœŸåŠ å¼ºé—¨æ¿å†…å±‚é’£é‡‘çš„åˆšæ€§ä¸å¯†å°å¤„ç†ã€‚`);
    }

    if (has_sub === 'no') {
        advice_items.push(`â„¹ï¸ <b>ä½é¢‘å»¶ä¼¸å—é™ï¼š</b> ç³»ç»Ÿæ— ç‹¬ç«‹è¶…ä½éŸ³ï¼Œæ•´è½¦æä½é¢‘æ®µ (20-${hpf_freq}Hz) çš„ç‰©ç†å›æ”¾èƒ½åŠ›å—é™ã€‚è¯·å‹¿å°è¯•ä½¿ç”¨ EQ å¼ºè¡Œæ‹”é«˜ä¸­ä½éŸ³çš„æä½é¢‘æ®µï¼Œä»¥å…å¼•èµ·æ‰¬å£°å™¨å†²ç¨‹è¿‡è½½æ‹åº•ã€‚`);
    }

    if (advice_items.length === 0 && !bs_flag) {
        advice_items.push(`âœ… <b>ç³»ç»ŸåŒ¹é…åˆç†ï¼š</b> å½“å‰è¾“å…¥çš„ç”µå£°å‚æ•°ä¸ç¯å¢ƒè®¾ç½®å‡å¤„äºåˆç†çš„å·¥ç¨‹å¸¸è§„åŒºé—´ã€‚å¯ä½œä¸ºåŸºå‡†å‚è€ƒæ‰§è¡Œè°ƒéŸ³ã€‚`);
    }

    document.getElementById('final_verdict_content').innerHTML = advice_items.map(item => `<div class="verdict-item"><div class="verdict-icon">ğŸ“Œ</div><div>${item}</div></div>`).join('');
}

function takeScreenshot() {
    const target = document.getElementById("capture-target");
    const btns = document.querySelector('.btn-group');
    btns.style.display = 'none'; 
    html2canvas(target, { backgroundColor: "#0f1419", scale: 2 }).then(canvas => {
        btns.style.display = 'grid'; 
        const link = document.createElement('a');
        link.download = `è½¦è½½ä½é¢‘ä»¿çœŸåˆ†ææŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}
</script>
</body>
</html>